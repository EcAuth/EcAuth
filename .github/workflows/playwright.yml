name: Playwright E2E Tests - IdentityProvider

on:
  push:
  pull_request:

jobs:
  test:
    runs-on: ubuntu-latest

    env:
      DB_PASSWORD: <YourStrong@Passw0rd>
      # MockIdP URL は secrets から取得（リポジトリにはコミットしない）
      MOCK_IDP_BASE_URL: ${{ secrets.MOCK_IDP_BASE_URL }}
      MOCK_IDP_ORG: dev

    services:
      sqlserver:
        image: mcr.microsoft.com/mssql/server:2019-latest
        env:
          SA_PASSWORD: ${{ env.DB_PASSWORD }}
          ACCEPT_EULA: "Y"
        ports:
          - 1433:1433
        options: >-
          --health-cmd "exit 0"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: Checkout repository
        uses: actions/checkout@v5

      - name: Load environment variables from .env.dist
        run: |
          # .env.dist を読み込み（変数展開を含むものは除外）
          grep -v '^\$' .env.dist | grep -v '^#' | grep -v '^$' | grep -v '\${' >> $GITHUB_ENV

      - name: Set up environment variables
        run: |
          echo "DB_HOST=localhost" >> $GITHUB_ENV
          echo "ConnectionStrings__EcAuthDbContext=Server=localhost;Database=${DB_NAME};User Id=${DB_USER};Password=${DB_PASSWORD};TrustServerCertificate=true;MultipleActiveResultSets=true" >> $GITHUB_ENV
          # MockIdP エンドポイント（外部環境を使用）
          # ?org= パラメータはマルチテナント対応のMockIdPで必須
          echo "FEDERATE_OAUTH2_CLIENT_ID=${MOCK_IDP_FEDERATE_CLIENT_ID}" >> $GITHUB_ENV
          echo "FEDERATE_OAUTH2_CLIENT_SECRET=${MOCK_IDP_FEDERATE_CLIENT_SECRET}" >> $GITHUB_ENV
          echo "FEDERATE_OAUTH2_AUTHORIZATION_ENDPOINT=${MOCK_IDP_BASE_URL}/authorization?org=${MOCK_IDP_ORG}" >> $GITHUB_ENV
          echo "FEDERATE_OAUTH2_TOKEN_ENDPOINT=${MOCK_IDP_BASE_URL}/token?org=${MOCK_IDP_ORG}" >> $GITHUB_ENV
          echo "FEDERATE_OAUTH2_USERINFO_ENDPOINT=${MOCK_IDP_BASE_URL}/userinfo?org=${MOCK_IDP_ORG}" >> $GITHUB_ENV
          # E2Eテスト用の環境変数
          echo "E2E_AUTHORIZATION_ENDPOINT=https://localhost:8081/authorization" >> $GITHUB_ENV
          echo "E2E_TOKEN_ENDPOINT=https://localhost:8081/token" >> $GITHUB_ENV
          echo "E2E_USERINFO_ENDPOINT=${MOCK_IDP_BASE_URL}/userinfo?org=${MOCK_IDP_ORG}" >> $GITHUB_ENV
          echo "E2E_REDIRECT_URI=https://localhost:8081/auth/callback" >> $GITHUB_ENV
          # MockIdP 単体テスト用
          echo "E2E_MOCK_IDP_REDIRECT_URI=http://localhost:8080/auth/callback" >> $GITHUB_ENV
        env:
          DB_NAME: ${{ env.DB_NAME }}
          DB_USER: ${{ env.DB_USER }}
          DB_PASSWORD: ${{ env.DB_PASSWORD }}
          MOCK_IDP_FEDERATE_CLIENT_ID: ${{ env.MOCK_IDP_FEDERATE_CLIENT_ID }}
          MOCK_IDP_FEDERATE_CLIENT_SECRET: ${{ env.MOCK_IDP_FEDERATE_CLIENT_SECRET }}
          # secrets から直接参照（ジョブレベルのenvでは空になるため）
          MOCK_IDP_BASE_URL: ${{ secrets.MOCK_IDP_BASE_URL }}
          MOCK_IDP_ORG: ${{ env.MOCK_IDP_ORG }}

      - name: Set up .NET
        uses: actions/setup-dotnet@v5
        with:
          dotnet-version: '9.0.x'

      - name: Add GitHub Packages source with credentials
        run: |
          dotnet nuget remove source github || true
          dotnet nuget add source https://nuget.pkg.github.com/EcAuth/index.json \
            --name github \
            --username ${{ github.actor }} \
            --password ${{ secrets.ORG_PAT || secrets.PACKAGES_READ_TOKEN }} \
            --store-password-in-clear-text

      - name: Restore .NET tools
        run: dotnet tool restore

      - name: Install dependencies
        run: dotnet restore ./EcAuth.sln

      - name: Build IdentityProvider
        run: dotnet build --no-restore --configuration Release IdentityProvider

      - name: Migrate IdentityProvider DB
        working-directory: IdentityProvider
        run: |
          dotnet ef database update
          # データベースが完全に起動するまで待機
          echo "Waiting for database to be fully online..."
          sleep 10

      - name: Start IdentityProvider
        run: |
          export ASPNETCORE_HTTPS_PORT=8081
          export ASPNETCORE_URLS="https://0.0.0.0:8081"
          # ログファイルに出力しながらバックグラウンドで起動
          dotnet run --project IdentityProvider --configuration Release --urls "https://0.0.0.0:8081" > /tmp/identityprovider.log 2>&1 &
          echo $! > /tmp/identityprovider.pid
          echo "IdentityProvider started with PID: $(cat /tmp/identityprovider.pid)"
        env:
          ASPNETCORE_ENVIRONMENT: Development

      - name: Wait for IdentityProvider to start
        run: |
          echo "Waiting for IdentityProvider to start..."
          for i in {1..60}; do
            if curl -sk https://localhost:8081/healthz > /dev/null 2>&1; then
              echo "IdentityProvider is ready"
              # 追加の安定待機時間
              sleep 5
              break
            fi
            # 起動に失敗した場合のログ出力
            if [ $i -eq 30 ]; then
              echo "=== IdentityProvider logs (intermediate check) ==="
              cat /tmp/identityprovider.log || echo "No logs available"
            fi
            echo "Waiting... ($i/60)"
            sleep 2
          done
          # 最終確認
          if ! curl -sk https://localhost:8081/healthz > /dev/null 2>&1; then
            echo "ERROR: IdentityProvider failed to start"
            echo "=== IdentityProvider logs ==="
            cat /tmp/identityprovider.log || echo "No logs available"
            exit 1
          fi

      - name: Install Node.js
        uses: actions/setup-node@v6
        with:
          node-version: 22

      - name: Install Playwright
        working-directory: E2ETests
        run: |
          yarn install --frozen-lockfile
          yarn playwright install --with-deps chromium

      - name: Run Playwright E2E Tests
        working-directory: E2ETests
        run: yarn playwright test
        env:
          # secrets から直接参照（env経由では空になるため）
          MOCK_IDP_BASE_URL: ${{ secrets.MOCK_IDP_BASE_URL }}
          MOCK_IDP_ORG: ${{ env.MOCK_IDP_ORG }}
          E2E_MOCK_IDP_REDIRECT_URI: ${{ env.E2E_MOCK_IDP_REDIRECT_URI }}

      - name: Upload evidence
        if: failure()
        uses: actions/upload-artifact@v5
        with:
          name: test-results
          path: 'E2ETests/test-results/'

      - name: Display IdentityProvider logs
        if: always()
        run: |
          echo "=== IdentityProvider logs ==="
          cat /tmp/identityprovider.log || echo "No logs available"
          echo "=== .NET exception logs ==="
          cat IdentityProvider/logs/*.log 2>/dev/null || echo "No exception logs found"
